// Generated by CoffeeScript 1.12.7
(function() {
  var FirmNewCtrl,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  FirmNewCtrl = (function(superClass) {
    extend(FirmNewCtrl, superClass);

    function FirmNewCtrl() {
      return FirmNewCtrl.__super__.constructor.apply(this, arguments);
    }

    FirmNewCtrl.prototype.events = {
      "singleTap a[data-action=save]": "onSave",
      "singleTap a[data-action=cancel]": "onCancel",
      "load #newFirm": "loadFirm",
      "unload #newFirm": "unloadFirm",
      "change #firDomain": "changeFirDomain"
    };

    FirmNewCtrl.prototype.elements = {
      "a[data-action=save]": "buttonSave",
      "a[data-action=cancel]": "buttonCancel",
      "#firName": "firName",
      "#firDomain": "firDomain",
      "#firServer": "firServer",
      "#firAddress": "firAddress",
      "#firCity": "firCity",
      "#firState": "firState",
      "#firCP": "firCP",
      "#firCountry": "firCountry",
      "#firResponName": "firResponName",
      "#firResponSurname": "firResponSurname",
      "#firResponEmail": "firResponEmail",
      "#firResponTelf1": "firResponTelf1",
      "#firBilledModule": "firBilledModule",
      "#firConfig": "firConfig",
      "#firClassTasks": "firClassTasks",
      "#firGwtUsers": "firGwtUsers"
    };

    FirmNewCtrl.prototype.changeFirDomain = function(event) {
      var asyn, data, firDom, firm, firmDom, url;
      firm = __FacadeCore.Cache_get(appName + "firmNew");
      firDom = "";
      if (firm) {
        firDom = firm.firDomain;
      }
      if (this.firDomain.val().length > 0 && (firDom.length === 0 || (firDom.length > 0 && firDom !== this.firDomain.val()))) {
        asyn = __FacadeCore.Service_Settings_asyncFalse();
        url = "http://" + appHost + "/firm/admin/get";
        data = {
          domain: this.firDomain.val()
        };
        firmDom = $$.json(url, data);
        __FacadeCore.Service_Settings_async(asyn);
        if (firmDom) {
          this.firDomain[0].focus();
          Lungo.Notification.success(findLangTextElement("label.notification.existsDomain.title"), findLangTextElement("label.notification.existsDomain.text"), null, 3);
          return false;
        }
      }
      return true;
    };

    FirmNewCtrl.prototype.loadFirm = function(event) {
      var a, asyn, firm, i, j, k, len, len1, objSelectMul, option, ref, results, strTaskClass, taskClass, tasksClass, url;
      firm = __FacadeCore.Cache_get(appName + "firmNew");
      asyn = __FacadeCore.Service_Settings_asyncFalse();
      url = "http://" + appHost + "/taskClass/operator/list";
      tasksClass = $$.json(url, null);
      tasksClass = Lungo.Core.orderByProperty(tasksClass, "tclName", "asc");
      __FacadeCore.Service_Settings_async(asyn);
      objSelectMul = Lungo.dom("#firm-form #firClassTasks");
      i = -1;
      for (j = 0, len = tasksClass.length; j < len; j++) {
        taskClass = tasksClass[j];
        i++;
        objSelectMul[0].options[i] = new Option(taskClass.tclName, taskClass.id);
      }
      if (firm) {
        this.firName.val(firm.firName);
        this.firDomain.val(firm.firDomain);
        this.firServer.val(firm.firServer);
        this.firAddress.val(firm.firAddress);
        this.firCity.val(firm.firCity);
        this.firState.val(firm.firState);
        this.firCP.val(firm.firCP);
        this.firCountry.val(firm.firCountry);
        this.firResponName.val(firm.firResponName);
        this.firResponSurname.val(firm.firResponSurname);
        this.firResponEmail.val(firm.firResponEmail);
        this.firResponTelf1.val(firm.firResponTelf1);
        this.firBilledModule[0].options.selectedIndex = firm.firBilledModule;
        this.firConfig.val(firm.firConfig);
        this.firGwtUsers.val(firm.firGwtUsers.toString());
        strTaskClass = firm.firClassTasks.toString();
        a = strTaskClass.split(",");
        ref = objSelectMul[0].options;
        results = [];
        for (k = 0, len1 = ref.length; k < len1; k++) {
          option = ref[k];
          if ((a.indexOf(option.value)) !== -1) {
            results.push(option.selected = true);
          } else {
            results.push(void 0);
          }
        }
        return results;
      } else {
        return this.firGwtUsers[0].disabled = true;
      }
    };

    FirmNewCtrl.prototype.onSave = function(event) {
      var _this, data, firm, i, j, len, objSelectMul, option, ref, strFirClass, url;
      if (this.changeFirDomain(event)) {
        __FacadeCore.Cache_remove(appName + "elementSave");
        __FacadeCore.Cache_remove(appName + "elementCancel");
        __FacadeCore.Cache_set(appName + "elementSave", this.buttonSave.html());
        __FacadeCore.Cache_set(appName + "elementCancel", this.buttonCancel.html());
        Lungo.Element.loading(this.buttonSave.selector, "black");
        Lungo.Element.loading(this.buttonCancel.selector, "black");
        url = "http://" + appHost + "/firm/admin/new";
        data = {
          firName: this.firName.val(),
          firDomain: this.firDomain.val(),
          firServer: this.firServer.val(),
          firAddress: this.firAddress.val(),
          firCity: this.firCity.val(),
          firState: this.firState.val(),
          firCP: this.firCP.val(),
          firCountry: this.firCountry.val(),
          firResponName: this.firResponName.val(),
          firResponSurname: this.firResponSurname.val(),
          firResponEmail: this.firResponEmail.val(),
          firResponTelf1: this.firResponTelf1.val(),
          firBilledModule: this.firBilledModule.val(),
          firConfig: this.firConfig.val(),
          firGwtUsers: this.firGwtUsers.val()
        };
        objSelectMul = Lungo.dom("#firm-form #firClassTasks");
        strFirClass = "";
        i = 0;
        ref = objSelectMul[0].options;
        for (j = 0, len = ref.length; j < len; j++) {
          option = ref[j];
          if (option.selected) {
            if (i > 0) {
              strFirClass += ",";
            }
            strFirClass += option.value;
            i++;
          }
        }
        data.firClassTasks = strFirClass;
        firm = __FacadeCore.Cache_get(appName + "firmNew");
        if (firm) {
          data.id = firm.firId;
        }
        _this = this;
        return $$.post(url, data, function(response) {
          return Lungo.Notification.success(findLangTextElement("label.notification.salvedData.title"), findLangTextElement("label.notification.salvedData.text"), null, 3, function(response) {
            __FacadeCore.Router_article("admin", "list-firm");
            AppAdmin.firmDomain = _this.firDomain.val();
            return _this.resetArticle();
          });
        });
      }
    };

    FirmNewCtrl.prototype.onCancel = function(event) {
      __FacadeCore.Cache_remove(appName + "elementSave");
      __FacadeCore.Cache_remove(appName + "elementCancel");
      __FacadeCore.Cache_set(appName + "elementSave", this.buttonSave.html());
      __FacadeCore.Cache_set(appName + "elementCancel", this.buttonCancel.html());
      Lungo.Element.loading(this.buttonSave.selector, "black");
      Lungo.Element.loading(this.buttonCancel.selector, "black");
      __FacadeCore.Router_article("admin", "list-firm");
      return this.resetArticle();
    };

    FirmNewCtrl.prototype.resetArticle = function() {
      this.buttonSave.html(__FacadeCore.Cache_get(appName + "elementSave"));
      this.buttonCancel.html(__FacadeCore.Cache_get(appName + "elementCancel"));
      this.firName.val("");
      this.firDomain.val("");
      this.firServer.val("");
      this.firAddress.val("");
      this.firCity.val("");
      this.firState.val("");
      this.firCP.val("");
      this.firCountry.val("");
      this.firResponName.val("");
      this.firResponSurname.val("");
      this.firResponEmail.val("");
      this.firResponTelf1.val("");
      this.firBilledModule.val("");
      this.firConfig.val("");
      this.firGwtUsers.val("");
      return this.firGwtUsers[0].disabled = false;
    };

    FirmNewCtrl.prototype.unloadFirm = function(event) {
      return __FacadeCore.Cache_remove(appName + "firmNew");
    };

    return FirmNewCtrl;

  })(Monocle.Controller);

  __Controller.FirmNew = new FirmNewCtrl("section#newFirm");

}).call(this);
